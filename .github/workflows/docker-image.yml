name: Build and Push Docker Images

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  DOCKER_HUB_REPO_FRONTEND: mcagbanlog/gresham-recordings-frontend
  DOCKER_HUB_REPO_BACKEND: mcagbanlog/gresham-recordings-backend

jobs:
  build-and-push:
    name: Build, Tag, and Push Docker Images
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Log in to Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 3. Set version from GitHub ref or fallback
    - name: Set Version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "push" ]]; then
          echo "VERSION=${{ github.sha }}" >> $GITHUB_ENV
        elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "VERSION=pr-${{ github.event.pull_request.number }}" >> $GITHUB_ENV
        else
          echo "VERSION=latest" >> $GITHUB_ENV
        fi

    # 4. Build Docker Compose images
    - name: Build Docker Compose Images
      run: |
        docker compose build

    # 5. Tag images with version and latest
    - name: Tag Docker Images
      run: |
        docker tag $DOCKER_HUB_REPO_FRONTEND:latest $DOCKER_HUB_REPO_FRONTEND:${{ env.VERSION }}
        docker tag $DOCKER_HUB_REPO_BACKEND:latest $DOCKER_HUB_REPO_BACKEND:${{ env.VERSION }}

    # 6. Push images to Docker Hub
    - name: Push Docker Images
      run: |
        docker push $DOCKER_HUB_REPO_FRONTEND:latest
        docker push $DOCKER_HUB_REPO_FRONTEND:${{ env.VERSION }}
        docker push $DOCKER_HUB_REPO_BACKEND:latest
        docker push $DOCKER_HUB_REPO_BACKEND:${{ env.VERSION }}
