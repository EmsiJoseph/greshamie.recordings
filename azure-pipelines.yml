trigger:
  branches:
    include:
      - backend-main

variables:
  - name: GITHUB_USERNAME
    value: EmsiJoseph
  - name: GITHUB_REPO
    value: greshamie.recordings.backend

pool:
  vmImage: 'ubuntu-latest'

steps:
- checkout: none

- script: |
    # Clone GitHub repo
    git clone https://$GITHUB_USERNAME:$GITHUB_PAT@github.com/$GITHUB_USERNAME/$GITHUB_REPO.git
    cd $GITHUB_REPO

    # Configure Git identity
    git config --global user.email "Mcjoseph.Agbanlog@wizard-ai.com"
    git config --global user.name "Azure DevOps"

    # Add Azure repo as remote
    git remote add azure $(Build.Repository.Uri)
    git fetch azure backend-main

    # Merge changes using subtree strategy
    git checkout main
    git subtree pull --prefix=backend azure backend-main --squash -m "Update backend from Azure"

    # Push changes safely
    git push origin main
  env:
    GITHUB_PAT: $(GITHUB_PAT)